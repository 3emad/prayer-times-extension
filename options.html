<!DOCTYPE html> 
<html>
<head>
<title>Prayer Times Options</title>
<link rel="stylesheet" type="text/css" href="/css/options.css">
<script src="http://maps.google.com/maps?file=api&amp;v=2.x&amp;key=ABQIAAAA8k8pIg1z-vAdcpqhpeR04hR53HbYEF0mLynKP7EnoFQKwKlG5BQpatQVDqwE2c_QgRmrX6_VlYH74w" type="text/javascript"></script>
<script type="text/javascript">
var bkg = chrome.extension.getBackgroundPage();
var map = null;

/**
* Saves options to localStorage.
*/
function saveOptions() {
  // Set the extension settings.
  var lat = parseFloat(document.getElementById('latitude').value);
  var lng = parseFloat(document.getElementById('longitude').value);
  var position =  lat + ',' + lng;
  bkg.settings.currentPosition = position;
  bkg.settings.timeformat = document.getElementById('timeformat').value;
  bkg.settings.calculation = document.getElementById('calculation').value;
  
  // Update visible time names.
  var timeNames = [];
  var timeNameNodes = document.getElementsByName('timenames');
  for (var i in timeNameNodes) {
    var timeNameNode = timeNameNodes[i];
    if (timeNameNode.checked) {
      timeNames.push(timeNameNode.id);
    }
  }
  bkg.settings.timenames = timeNames;
  
  // Update prayer settings.
  var entity = bkg.getPrayerEntity();
  var prayTime = entity.getPrayTime()
  prayTime.setMethod(bkg.settings.calculation);
  prayTime.setTimeFormat(bkg.settings.timeformat);
  entity.setLatitude(lat);
  entity.setLongitude(lng)
  
  // Refresh timetable to get new prayer time.
  var views = chrome.extension.getViews();
  for (var i in views) {
    var location = views[i].location;
    if (location.pathname == '/timetable.html') {
      location.reload();
    }
  }
  
  // Update status to let user know options were saved.
  var info = document.getElementById('info-message');
  info.style.display = 'inline';
  info.style.opacity = 1;
  setTimeout(function() {
    info.style.opacity = 0.0;
  }, 1000);
}

/**
 * Translations for labels.
 */
function translateLabels() {
  document.getElementById('header-label').innerHTML =
      chrome.i18n.getMessage('extName') + ' ' +
      chrome.i18n.getMessage('options');
  document.getElementById('options-warning-label').innerHTML =
      chrome.i18n.getMessage('optionsWarning');
  document.getElementById('location-settings-label').innerHTML = 
      chrome.i18n.getMessage('locationSettings');
  document.getElementById('geolocation-label').innerHTML = 
      chrome.i18n.getMessage('geolocation');
  document.getElementById('latitude-label').value = 
      chrome.i18n.getMessage('latitude');
  document.getElementById('longitude-label').value = 
      chrome.i18n.getMessage('longitude');
  document.getElementById('choose-location-label').innerHTML = 
      chrome.i18n.getMessage('chooseLocation');
  document.getElementById('mygeolocation-label').innerHTML = 
      chrome.i18n.getMessage('myGeoLocation');
  document.getElementById('location-map-label').innerHTML = 
      chrome.i18n.getMessage('locationOnMap');
  document.getElementById('time-settings-label').innerHTML = 
      chrome.i18n.getMessage('locationSettings');
  document.getElementById('time-format-label').innerHTML = 
      chrome.i18n.getMessage('timeFormat');
  document.getElementById('calculation-settings-label').innerHTML = 
      chrome.i18n.getMessage('calculationsSettings');
  document.getElementById('visible-timenames-label').innerHTML = 
      chrome.i18n.getMessage('visibleTimenames');
  document.getElementById('calculation-method-label').innerHTML =
      chrome.i18n.getMessage('calculationMethod');
  document.getElementById('save-label').innerHTML = 
      chrome.i18n.getMessage('save');
  document.getElementById('close-label').innerHTML = 
      chrome.i18n.getMessage('close');
  document.getElementById('info-message').innerHTML = 
      chrome.i18n.getMessage('optionSaveResponse');
  document.getElementById('extension-by-label').innerHTML = 
      chrome.i18n.getMessage('extBy');
  document.getElementById('extension-source-label').innerHTML = 
      chrome.i18n.getMessage('extSource');
}

/**
* Restore all options.
*/
function restoreOptions() {
  translateLabels();

  // Add calculations settings.
  var calculationElement = document.getElementById('calculation');
  var entity = bkg.getPrayerEntity();
  calculationElement.add(createCalculationOption(entity, 'Jafari'));
  calculationElement.add(createCalculationOption(entity, 'Tehran'));
  calculationElement.add(createCalculationOption(entity, 'MWL'));
  calculationElement.add(createCalculationOption(entity, 'ISNA'));
  calculationElement.add(createCalculationOption(entity, 'Egypt'));
  calculationElement.add(createCalculationOption(entity, 'Makkah'));
  calculationElement.add(createCalculationOption(entity, 'Karachi'));
  
  // Add timenames group.
  var timenames = entity.getTimeNames();
  var timenamesgroup = document.getElementById('timenamesgroup');
  timenamesgroup.appendChild(createTimenamesGroup([timenames.imsak,
                                                   timenames.fajr, 
                                                   timenames.sunrise]));
  timenamesgroup.appendChild(createTimenamesGroup([timenames.dhuhr, 
                                                   timenames.asr, 
                                                   timenames.sunset]));
  timenamesgroup.appendChild(createTimenamesGroup([timenames.maghrib, 
                                                   timenames.isha, 
                                                   timenames.midnight]));
  
  // Restore settings.
  document.getElementById('version').innerHTML = ' (v' + bkg.settings.version + ')';
  document.getElementById('timeformat').value = bkg.settings.timeformat;
  document.getElementById('calculation').value = bkg.settings.calculation;
  
  var position = bkg.settings.currentPosition;
  if (position) {
    var index = position.indexOf(',');
    var lat = parseFloat(position.substring(0, index));
    var lng = parseFloat(position.substring(index + 1, position.length));
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lng;
  }
  
  // Show position on map.
  map = new GMap2(document.getElementById("map_canvas"));
  map.setCenter(new GLatLng(lat, lng), 13);
  var marker = new GMarker(new GPoint(lng, lat));
  map.addOverlay(marker);
              
  // Restore timenames.
  if (bkg.settings.timenames) {
    var timeNames = bkg.settings.timenames;
    for (var i in timeNames) {
      document.getElementById(timeNames[i]).checked = true;
    }
  }
}

/**
 * Creates the DOM for the calculation option.
 * @param {Array<string>} An array of times.
 * @returns {HTMLElement} an paragraph element.
 */
function createTimenamesGroup(times) {
  var p = document.createElement('p');
  p.setAttribute('class', 'visibleTimeNamesList');
  for (var i in times) {
    var input = document.createElement('input');
    var time = times[i];
    input.setAttribute('type', 'checkbox');
    input.setAttribute('name', 'timenames');
    input.setAttribute('id', time);
    p.appendChild(input);
    var label = document.createElement('label');
    label.setAttribute('for', time);
    label.innerHTML = time;
    p.appendChild(label);
  }
  return p;
}

/**
 * Creates the DOM for the calculation option.
 * @param {object<Entity>} entity The prayer entity.
 * @param {string} value The value of the calculation.
 * @returns {HTMLElement} an option element.
 */
function createCalculationOption(entity, value) {
  var option = document.createElement('option');
  option.text = entity.getCalculationName(value);
  option.value = value;
  return option;
}

/**
 * Using Geolocation API, get the user address automatically and graph it.
 */
function chooseMyLocation() {
  var entity = bkg.getPrayerEntity();
  entity.getGeolocation(function(lat, lng) {
    map.clearOverlays();
    map.setCenter(new GLatLng(lat, lng), 13);
    var marker = new GMarker(new GPoint(lng, lat));
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lng;
    map.addOverlay(marker);
  });
}

/**
 * Enable editing mode so the user can input an address manually.
 */
function chooseLocation() {
  var locationDOM = document.getElementById('locationSection');
  var gmapsDOM = document.createElement('div');
  gmapsDOM.setAttribute('id', 'gmaps');
  
  // Search input.
  var input = document.createElement('input');
  input.setAttribute('type', 'text');
  input.setAttribute('size', '60');
  input.setAttribute('id', 'address');
  input.setAttribute('placeholder', chrome.i18n.getMessage('searchPlaceholder'));
  gmapsDOM.appendChild(input);
  
  // Search button.
  var searchButton = document.createElement('button');
  searchButton.setAttribute('onclick', 'getAddress();');
  searchButton.innerHTML = chrome.i18n.getMessage('search');
  gmapsDOM.appendChild(searchButton);
  
  // Cancel button.
  var cancelButton = document.createElement('button');
  cancelButton.setAttribute('onclick', 'cancelAddress();');
  cancelButton.innerHTML = chrome.i18n.getMessage('cancel');
  gmapsDOM.appendChild(cancelButton);

  locationDOM.parentNode.appendChild(gmapsDOM);
  locationDOM.style.display = 'none';
}

/**
 * Cancel the editing mode for typing an address.
 */
function cancelAddress() {
  var locationDOM = document.getElementById('locationSection');
  locationDOM.style.display = 'block';
  var gmapsDOM = document.getElementById('gmaps');
  locationDOM.parentNode.removeChild(gmapsDOM);
}

/**
 * Using Google Maps API, get the current address typed in the text field.
 */
function getAddress() { 
  var address = document.getElementById('address').value;
  var geocoder = new GClientGeocoder();
  geocoder.getLatLng(
    address,
    function(point) {
      if (!point) {
        alert(address + ' ' + chrome.i18n.getMessage('notFound'));
      } else {
        map.clearOverlays();
        map.setCenter(point, 13);
        var marker = new GMarker(point);
        map.addOverlay(marker);
        document.getElementById('latitude').value = point.lat();
        document.getElementById('longitude').value = point.lng();
        cancelAddress();
      }
    }
  );
}

</script>
</head>

<body onload="restoreOptions()"> 
  <form onsubmit="return false;">
  <div id="body-container">
    <div id="header">
      <h1><span id="header-label"></span><em id="version"></em></h1>
    </div>
    <p id="options-warning-label"></p>
    <div class="extension-template">
      <div class="extension-header" id="location-settings-label"></div>
      <div class="extension-options">
        <dl>
          <dt id="geolocation-label"></dt>
          <dd>
            <div id="locationSection">
              <span id="latitude-label"></label>
              <input readonly="readonly" type="text" id="latitude" disabled="disabled" /> 
              <span id="longitude-label"></label>
              <input readonly="readonly" type="text" id="longitude" disabled="disabled" /> 
              <button onclick="chooseLocation()" id="choose-location-label"></button>
              <button onclick="chooseMyLocation()" id="mygeolocation-label"></button>
            </div>
          </dd>
          <dt id="location-map-label"></dt>
          <dd>
            <div id="map_canvas"></div>
          </dd>
        </dl>
      </div>
    </div>
    <div class="extension-template">
      <div class="extension-header" id="time-settings-label"></div>
      <div class="extension-options">
        <dl>
          <dt id="time-format-label"></dt>
          <dd>
            <select id="timeformat">
              <option value="24h">24 hour</option>
              <option value="12h">12 hour</option>
              <option value="12hNS">12 hour with no suffix</option>
            </select>
          </dd>
          <dt id="visible-timenames-label"></dt>
          <dd id="timenamesgroup"></dd>
        </dl>
      </div>
    </div>
    <div class="extension-template">
      <div class="extension-header" id="calculation-settings-label"></div>
      <div class="extension-options">
        <dl>
          <dt id="calculation-method-label"></dt>
          <dd>
            <select id="calculation"></select>
          </dd>
        </dl>
      </div>
    </div>
    <div id="extension-footer">
      <span id="info-message"></span>
      <button onclick="saveOptions();" id="save-label"></button>
      <button onclick="window.close();" id="close-label"></button>
    </div>
    <div id="credits">
      <span id="extension-by-label"></span> <a href="http://www.mohamedmansour.com">Mohamed Mansour</a>, 
      <span id="extension-source-label"></span> <a href="http://github.com/mohamedmansour/prayer-times-extension">GitHub</a>
    </div>
  </div>
  </form>
</body>
</html>